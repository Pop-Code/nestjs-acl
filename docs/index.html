<!doctype html>
<html class="default no-js">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Nestjs ACL Documentation</title>
	<meta name="description" content="Documentation for Nestjs ACL Documentation">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
<header>
	<div class="tsd-page-toolbar">
		<div class="container">
			<div class="table-wrap">
				<div class="table-cell" id="tsd-search" data-index="assets/js/search.json" data-base=".">
					<div class="field">
						<label for="tsd-search-field" class="tsd-widget search no-caption">Search</label>
						<input id="tsd-search-field" type="text" />
					</div>
					<ul class="results">
						<li class="state loading">Preparing search index...</li>
						<li class="state failure">The search index is not available</li>
					</ul>
					<a href="index.html" class="title">Nestjs ACL Documentation</a>
				</div>
				<div class="table-cell" id="tsd-widgets">
					<div id="tsd-filter">
						<a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a>
						<div class="tsd-filter-group">
							<div class="tsd-select" id="tsd-filter-visibility">
								<span class="tsd-select-label">All</span>
								<ul class="tsd-select-list">
									<li data-value="public">Public</li>
									<li data-value="protected">Public/Protected</li>
									<li data-value="private" class="selected">All</li>
								</ul>
							</div>
							<input type="checkbox" id="tsd-filter-inherited" checked />
							<label class="tsd-widget" for="tsd-filter-inherited">Inherited</label>
							<input type="checkbox" id="tsd-filter-only-exported" />
							<label class="tsd-widget" for="tsd-filter-only-exported">Only exported</label>
						</div>
					</div>
					<a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a>
				</div>
			</div>
		</div>
	</div>
	<div class="tsd-page-title">
		<div class="container">
			<ul class="tsd-breadcrumb">
				<li>
					<a href="globals.html">Globals</a>
				</li>
			</ul>
			<h1>Nestjs ACL Documentation</h1>
		</div>
	</div>
</header>
<div class="container container-main">
	<div class="row">
		<div class="col-8 col-content">
			<div class="tsd-panel tsd-typography">
				<a href="#nestjs-acl" id="nestjs-acl" style="color: inherit; text-decoration: none;">
					<h1>Nestjs ACL</h1>
				</a>
				<p><a href="https://github.com/Pop-Code/nestjs-acl/actions"><img src="https://github.com/Pop-Code/nestjs-acl/workflows/CI/badge.svg" alt="Actions Status"></a>
					<a href="https://codecov.io/gh/Pop-Code/nestjs-acl"><img src="https://codecov.io/gh/Pop-Code/nestjs-acl/branch/master/graph/badge.svg" alt="codecov"></a>
					<a href="https://npmcharts.com/compare/nestjs-acl?minimal=true"><img src="https://img.shields.io/npm/dm/nestjs-acl.svg?style=flat" alt="NPM Downloads"></a>
					<img src="https://img.shields.io/node/v/nestjs-acl" alt="node">
					<img src="https://img.shields.io/npm/v/nestjs-console/latest" alt="npm (tag)">
				<img src="https://img.shields.io/npm/dependency-version/nestjs-console/peer/@nestjs/core" alt="npm peer dependency version (scoped)"></p>
				<a href="#why-the-nestjs-acl-module" id="why-the-nestjs-acl-module" style="color: inherit; text-decoration: none;">
					<h2>Why the nestjs-acl module?</h2>
				</a>
				<p>The <a href="https://www.npmjs.com/package/nestjs-acl">nestjs-acl</a> module purpose is to check several access rules at the same time, depending on the current context.<br>It allows to store, manage and check scenarios of access rules and to check them at any time.</p>
				<p>In our case, we needed to finely filter access to different types of resources for different types of users.
				Because some scenarios are repetitive, it was important to store these rules without repeating tones of code lines.</p>
				<p><a href="https://www.npmjs.com/package/nestjs-acl">nestjs-acl</a> does not replace the nest-access-control module, they are fully compatible and complementary.
				nest-access-control is a module to protect methods using decorators. It also allows you to implement your own access logic using the Nestjs Guards, which covers most cases.</p>
				<a href="#install" id="install" style="color: inherit; text-decoration: none;">
					<h2>Install</h2>
				</a>
				<a href="#using-npm" id="using-npm" style="color: inherit; text-decoration: none;">
					<h4>Using npm</h4>
				</a>
				<p><code>npm install accesscontrol nestjs-acl --save</code></p>
				<a href="#using-yarn" id="using-yarn" style="color: inherit; text-decoration: none;">
					<h4>Using yarn</h4>
				</a>
				<p><code>yarn add accesscontrol nestjs-acl</code></p>
				<a href="#prepare-the-roles" id="prepare-the-roles" style="color: inherit; text-decoration: none;">
					<h3>Prepare the roles</h3>
				</a>
				<p>Create a file that exports an AccessControl instance.
				You can refer to the npm package <a href="https://www.npmjs.com/package/commander">accesscontrol</a> to learn how to manipulate roles</p>
				<p><em>Note: The roles instance could be manipulate at runtime</em></p>
				<pre><code class="language-ts"><span class="hljs-comment">// roles.ts</span>
<span class="hljs-keyword">import</span> { AccessControl } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;accesscontrol&#x27;</span>;

<span class="hljs-comment">// See npm package accesscontrol for details</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> roles = <span class="hljs-keyword">new</span> AccessControl({
    ADMIN: {
        doSomething: {
            <span class="hljs-string">&#x27;create:any&#x27;</span>: [<span class="hljs-string">&#x27;*&#x27;</span>]
        },
        doSomethingElse: {
            <span class="hljs-string">&#x27;create:any&#x27;</span>: [<span class="hljs-string">&#x27;*&#x27;</span>]
        }
    },
    USER: {
        doSomething: {
            <span class="hljs-string">&#x27;create:own&#x27;</span>: [<span class="hljs-string">&#x27;*&#x27;</span>]
        }
    }
});</code></pre>
				<a href="#create-and-register-aclrulescreators" id="create-and-register-aclrulescreators" style="color: inherit; text-decoration: none;">
					<h3>Create and register AclRulesCreators</h3>
				</a>
				<ol>
					<li>The AclService will search for matching AclRulesCreator and execute them passing the context.</li>
					<li>If a AclRulesCreator is not found, the check passes (only if option rejectIfNoRule === false)</li>
					<li>If a AclRulesCreator is found, The creator is executed. if option rejectIfNoRule === true and no rule was returned by the creator, the check will fail.</li>
					<li>Returned Rules from AclRulesCreator are tested<ul>
							<li>The first rule that is granted will validate the test.</li>
							<li>The first rule that throw an Error will stop the chain and invalidate the test.</li>
							<li>Rules returning false are ignored</li>
							<li>Rules returning Error are concatenated, returned as a single Error if no granted rule was found</li>
						</ul>
					</li>
				</ol>
				<pre><code class="language-ts"><span class="hljs-comment">// rules.ts</span>

<span class="hljs-comment">/**
 * Based on roles
 * users with the USER role will pass this scenarios only if they own the data (check returns true)
 * users with the ADMIN role will pass this scenarios
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userCanDoSomething = <span class="hljs-function">(<span class="hljs-params">opts</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> {
        context: { user }, <span class="hljs-comment">// the context passed to the test</span>
        data, <span class="hljs-comment">// the data passed to the test</span>
        sourceData <span class="hljs-comment">// the source data passed to the test</span>
    } = opts;
    <span class="hljs-keyword">return</span> [
        <span class="hljs-comment">// rule 1</span>
        {
            req: opts.rolesBuilder.can(opts.context.user.roles).createOwn(<span class="hljs-string">&#x27;doSomething&#x27;</span>),
            <span class="hljs-comment">// do an extra check if with context</span>
            check: <span class="hljs-function">() =&gt;</span> opts.data.user === context.user
        },
        <span class="hljs-comment">// rule 2</span>
        {
            req: opts.rolesBuilder.can(opts.context.user.roles).createAny(<span class="hljs-string">&#x27;doSomething&#x27;</span>)
        }
    ];
};

<span class="hljs-comment">/**
 * Based on roles, only users with ADMIN role will be ale to pass this scenarios
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> userCanDoSomethingElse = <span class="hljs-function">(<span class="hljs-params">opts</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> [
        {
            req: opts.rolesBuilder.can(opts.context.user.roles).createAny(<span class="hljs-string">&#x27;doSomethingElse&#x27;</span>)
        }
    ];
};</code></pre>
				<a href="#import-and-register-the-aclmodule-module" id="import-and-register-the-aclmodule-module" style="color: inherit; text-decoration: none;">
					<h3>Import and register the AclModule module</h3>
				</a>
				<p>The AclModule is global and need to be registered once, imported modules can inject the AclService without the need to register the module again.</p>
				<pre><code class="language-ts"><span class="hljs-comment">// mymodule.ts</span>
<span class="hljs-keyword">import</span> { AclModule, AclService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nestjs-acl&#x27;</span>;
<span class="hljs-keyword">import</span> { roles } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./roles&#x27;</span>;
<span class="hljs-keyword">import</span> { userCanDoSomething, userCanDoSomethingElse } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./rules&#x27;</span>;
<span class="hljs-keyword">import</span> { MyProvider } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./provider&#x27;</span>;

<span class="hljs-meta">@Module</span>({
    imports: [AclModule.register(roles), MyProvider]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> MyModule {
    construtor(<span class="hljs-keyword">protected</span> acl: AclService) {
        <span class="hljs-comment">// register acl rules creators</span>
        <span class="hljs-built_in">this</span>.acl
            .registerRules(<span class="hljs-string">&#x27;userCanDoSomething&#x27;</span>, userCanDoSomething)
            .registerRules(<span class="hljs-string">&#x27;userCanDoSomethingElse&#x27;</span>, userCanDoSomethingElse);
    }
}</code></pre>
				<a href="#using-the-aclservice" id="using-the-aclservice" style="color: inherit; text-decoration: none;">
					<h3>Using the AclService</h3>
				</a>
				<p>In your modules, providers or controllers you can now inject the AclService instance and use it to check acl rules.</p>
				<pre><code class="language-ts"><span class="hljs-comment">// myprovider.ts</span>
<span class="hljs-keyword">import</span> { Injectable } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@nestjs/common&#x27;</span>;
<span class="hljs-keyword">import</span> { AclService } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;nestjs-acl&#x27;</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> MyProvider {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">protected</span> acl: AclService</span>) {}

    <span class="hljs-comment">/**
     * This method is protected by a rule with id userCanDoSomething
     */</span>
    <span class="hljs-keyword">async</span> doSomething(user: AclRoles&lt;<span class="hljs-built_in">string</span>&gt;) {
        <span class="hljs-keyword">const</span> data = { foo: <span class="hljs-string">&#x27;bar&#x27;</span>, user };

        <span class="hljs-comment">// The AclService will throw a ForbiddenException if the check fails.</span>
        <span class="hljs-keyword">const</span> { rule, data } = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.acl.check({
            id: <span class="hljs-string">&#x27;userCanDoSomething&#x27;</span>,
            data,
            context: {
                user: {
                    roles: user.roles
                }
            }
        });

        <span class="hljs-comment">// Do something...</span>
    }

    <span class="hljs-comment">/**
     * This method is protected by a rule with id userCanDoSomethingElse
     */</span>
    <span class="hljs-keyword">async</span> doSomethingElse(user: AclRoles&lt;<span class="hljs-built_in">string</span>&gt;) {
        <span class="hljs-keyword">const</span> { rule, data } = <span class="hljs-keyword">await</span> <span class="hljs-built_in">this</span>.acl.check({
            id: <span class="hljs-string">&#x27;userCanDoSomethingElse&#x27;</span>,
            context: {
                user: {
                    roles: user.roles
                }
            }
        });

        <span class="hljs-comment">// Do something else...</span>
    }
}</code></pre>
				<a href="#api-documentation" id="api-documentation" style="color: inherit; text-decoration: none;">
					<h3><a href="https://pop-code.github.io/nestjs-acl">API DOCUMENTATION</a></h3>
				</a>
				<a href="#changelog" id="changelog" style="color: inherit; text-decoration: none;">
					<h3><a href="https://github.com/Pop-Code/nestjs-acl/blob/master/CHANGELOG.md">CHANGELOG</a></h3>
				</a>
			</div>
		</div>
		<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
			<nav class="tsd-navigation primary">
				<ul>
					<li class="globals  ">
						<a href="globals.html"><em>Globals</em></a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_constants_.html">&quot;constants&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_decorators_.html">&quot;decorators&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_index_.html">&quot;index&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_interfaces_.html">&quot;interfaces&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_module_.html">&quot;module&quot;</a>
					</li>
					<li class=" tsd-kind-module">
						<a href="modules/_service_.html">&quot;service&quot;</a>
					</li>
				</ul>
			</nav>
			<nav class="tsd-navigation secondary menu-sticky">
				<ul class="before-current">
				</ul>
			</nav>
		</div>
	</div>
</div>
<footer>
	<div class="container">
		<h2>Legend</h2>
		<div class="tsd-legend-group">
			<ul class="tsd-legend">
				<li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li>
				<li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li>
				<li class="tsd-kind-type-alias tsd-has-type-parameter"><span class="tsd-kind-icon">Type alias with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li>
				<li class="tsd-kind-interface tsd-has-type-parameter"><span class="tsd-kind-icon">Interface with type parameter</span></li>
			</ul>
			<ul class="tsd-legend">
				<li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li>
			</ul>
		</div>
	</div>
</footer>
<div class="overlay"></div>
<script src="assets/js/main.js"></script>
</body>
</html>